name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'docker-bake.hcl'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.extract.outputs.release }}
      release_suffix: ${{ steps.extract.outputs.release_suffix }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Extract RELEASE and RELEASE_SUFFIX from docker-bake.hcl
        id: extract
        run: |
          RELEASE=$(grep 'variable "RELEASE"' -A 2 docker-bake.hcl | grep 'default' | sed 's/.*"\(.*\)"/\1/')
          RELEASE_SUFFIX=$(grep 'variable "RELEASE_SUFFIX"' -A 2 docker-bake.hcl | grep 'default' | sed 's/.*"\(.*\)"/\1/')
          echo "release=${RELEASE}" >> $GITHUB_OUTPUT
          echo "release_suffix=${RELEASE_SUFFIX}" >> $GITHUB_OUTPUT
          echo "Current RELEASE: ${RELEASE}"
          echo "Current RELEASE_SUFFIX: ${RELEASE_SUFFIX}"

      - name: Check if RELEASE or RELEASE_SUFFIX changed
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "Manual trigger - will build"
            exit 0
          fi

          git diff -U3 HEAD^ HEAD docker-bake.hcl > /tmp/diff.txt
          echo "=== Diff of docker-bake.hcl ==="
          cat /tmp/diff.txt
          echo "================================"

          PREV_RELEASE=$(git show HEAD^:docker-bake.hcl | grep -A 2 'variable "RELEASE"' | grep 'default' | sed 's/.*"\(.*\)"/\1/')
          PREV_RELEASE_SUFFIX=$(git show HEAD^:docker-bake.hcl | grep -A 2 'variable "RELEASE_SUFFIX"' | grep 'default' | sed 's/.*"\(.*\)"/\1/')
          CURR_RELEASE="${{ steps.extract.outputs.release }}"
          CURR_RELEASE_SUFFIX="${{ steps.extract.outputs.release_suffix }}"

          echo "Previous RELEASE: '${PREV_RELEASE}'"
          echo "Current RELEASE: '${CURR_RELEASE}'"
          echo "Previous RELEASE_SUFFIX: '${PREV_RELEASE_SUFFIX}'"
          echo "Current RELEASE_SUFFIX: '${CURR_RELEASE_SUFFIX}'"

          if [ "${PREV_RELEASE}" != "${CURR_RELEASE}" ] || [ "${PREV_RELEASE_SUFFIX}" != "${CURR_RELEASE_SUFFIX}" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "RELEASE or RELEASE_SUFFIX changed - will build"
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
            echo "No RELEASE or RELEASE_SUFFIX changes detected - skipping build"
          fi

  build-and-push:
    needs: detect-changes
    if: needs.detect-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      images: ${{ steps.list-images.outputs.images }}
      images_json: ${{ steps.list-images.outputs.images_json }}
      dockerhub_images: ${{ steps.list-images.outputs.dockerhub_images }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        run: |
          sudo swapoff -a
          sudo rm -rf /swapfile /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt clean
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host
          buildkitd-flags: --debug

      # ðŸ†• Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # Login to GitHub Container Registry (keep existing)
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ðŸ†• Build and push to BOTH registries
      - name: Build and push all images (serially)
        env:
          GHCR_REGISTRY: ghcr.io
          GHCR_USER: ${{ github.repository_owner }}
          DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # Function to build and push to both registries
          build_and_push() {
            local target=$1
            echo "Building ${target}..."
            
            # Build and push to GHCR
            REGISTRY=ghcr.io REGISTRY_USER="${GHCR_USER}" docker buildx bake --push ${target}
            
            # Tag and push to Docker Hub
            RELEASE="${{ needs.detect-changes.outputs.release }}"
            RELEASE_SUFFIX="${{ needs.detect-changes.outputs.release_suffix }}"
            GHCR_IMAGE="ghcr.io/${GHCR_USER}/comfyui:${target}-${RELEASE}${RELEASE_SUFFIX}"
            DOCKERHUB_IMAGE="${DOCKERHUB_USER}/comfyui:${target}-${RELEASE}${RELEASE_SUFFIX}"
            DOCKERHUB_LATEST="${DOCKERHUB_USER}/comfyui:${target}-latest"
            
            docker pull ${GHCR_IMAGE}
            docker tag ${GHCR_IMAGE} ${DOCKERHUB_IMAGE}
            docker tag ${GHCR_IMAGE} ${DOCKERHUB_LATEST}
            docker push ${DOCKERHUB_IMAGE}
            docker push ${DOCKERHUB_LATEST}
            
            # Cleanup
            docker buildx prune -af
            df -h
          }

          # Build each variant
          build_and_push "cu124-py311"
          build_and_push "cu124-py312"
          build_and_push "cu128-py311"
          build_and_push "cu128-py312"

          echo "All images built and pushed successfully!"

      - name: List built images
        id: list-images
        run: |
          RELEASE="${{ needs.detect-changes.outputs.release }}"
          RELEASE_SUFFIX="${{ needs.detect-changes.outputs.release_suffix }}"
          GHCR_USER="${{ github.repository_owner }}"
          DOCKERHUB_USER="${{ secrets.DOCKERHUB_USERNAME }}"
          APP="comfyui"

          # GHCR images
          GHCR_IMAGES=(
            "ghcr.io/${GHCR_USER}/${APP}:cu124-py311-${RELEASE}${RELEASE_SUFFIX}"
            "ghcr.io/${GHCR_USER}/${APP}:cu124-py312-${RELEASE}${RELEASE_SUFFIX}"
            "ghcr.io/${GHCR_USER}/${APP}:cu128-py311-${RELEASE}${RELEASE_SUFFIX}"
            "ghcr.io/${GHCR_USER}/${APP}:cu128-py312-${RELEASE}${RELEASE_SUFFIX}"
          )

          # Docker Hub images
          DOCKERHUB_IMAGES=(
            "${DOCKERHUB_USER}/${APP}:cu124-py311-${RELEASE}${RELEASE_SUFFIX}"
            "${DOCKERHUB_USER}/${APP}:cu124-py311-latest"
            "${DOCKERHUB_USER}/${APP}:cu124-py312-${RELEASE}${RELEASE_SUFFIX}"
            "${DOCKERHUB_USER}/${APP}:cu124-py312-latest"
            "${DOCKERHUB_USER}/${APP}:cu128-py311-${RELEASE}${RELEASE_SUFFIX}"
            "${DOCKERHUB_USER}/${APP}:cu128-py311-latest"
            "${DOCKERHUB_USER}/${APP}:cu128-py312-${RELEASE}${RELEASE_SUFFIX}"
            "${DOCKERHUB_USER}/${APP}:cu128-py312-latest"
          )

          # Create outputs
          GHCR_LIST=$(printf '%s\n' "${GHCR_IMAGES[@]}")
          DOCKERHUB_LIST=$(printf '%s\n' "${DOCKERHUB_IMAGES[@]}")
          GHCR_JSON=$(printf '%s\n' "${GHCR_IMAGES[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          DOCKERHUB_JSON=$(printf '%s\n' "${DOCKERHUB_IMAGES[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "images<<EOF" >> $GITHUB_OUTPUT
          echo "$GHCR_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "dockerhub_images<<EOF" >> $GITHUB_OUTPUT
          echo "$DOCKERHUB_LIST" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "images_json=${GHCR_JSON}" >> $GITHUB_OUTPUT
          echo "dockerhub_images_json=${DOCKERHUB_JSON}" >> $GITHUB_OUTPUT

          # Write to files
          echo "$GHCR_LIST" > built-images-ghcr.txt
          echo "$DOCKERHUB_LIST" > built-images-dockerhub.txt
          echo "$GHCR_JSON" > built-images-ghcr.json
          echo "$DOCKERHUB_JSON" > built-images-dockerhub.json

      - name: Upload image list artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images-list
          path: |
            built-images-*.txt
            built-images-*.json
          retention-days: 90

      - name: Display built images
        run: |
          echo "=== GitHub Container Registry ==="
          cat built-images-ghcr.txt
          echo ""
          echo "=== Docker Hub ==="
          cat built-images-dockerhub.txt

  create-summary:
    needs: [detect-changes, build-and-push]
    if: needs.detect-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create job summary
        run: |
          echo "## Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ needs.detect-changes.outputs.release }}${{ needs.detect-changes.outputs.release_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“¦ GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.build-and-push.outputs.images }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ³ Docker Hub:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.build-and-push.outputs.dockerhub_images }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "ðŸ“¥ Download the complete image list from the artifacts section above." >> $GITHUB_STEP_SUMMARY